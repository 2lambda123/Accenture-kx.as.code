import java.lang.management.*

mb = 1024*1024;
gb = mb*1024;

def os = ManagementFactory.operatingSystemMXBean;
long freePhysicalMemorySize = os.getFreePhysicalMemorySize() / mb;
long totalPhysicalMemorySize = os.getTotalPhysicalMemorySize() / mb;

int totalSystemCores = Runtime.getRuntime().availableProcessors();

File f = new File("/");
def currentSystemDisk = f.getAbsolutePath();
long totalSystemDisk = f.getTotalSpace() / gb;
long freeSystemDisk = f.getFreeSpace() / gb;
long usableSystemDisk = f.getUsableSpace() / gb;

def localVolumeParameterElements = LOCAL_STORAGE_OPTIONS.split(';')

int number1GbVolumes = localVolumeParameterElements[0].toInteger()
int number5GbVolumes = localVolumeParameterElements[1].toInteger()
int number10GbVolumes = localVolumeParameterElements[2].toInteger()
int number30GbVolumes = localVolumeParameterElements[3].toInteger()
int number50GbVolumes = localVolumeParameterElements[4].toInteger()

int totalLocalDiskSpace = totalSystemDisk.toInteger()
int remainingDiskSpace = freeSystemDisk.toInteger()
int totalLocalStorageRequired

if ( ALLOW_WORKLOADS_ON_KUBERNETES_MASTER == "true" ) {
totalLocalStorageRequired = ( number1GbVolumes + (number5GbVolumes * 5) + (number10GbVolumes * 10) + (number30GbVolumes * 30) + (number50GbVolumes * 50) ) * ( NUMBER_OF_KX_MAIN_NODES.toInteger() + NUMBER_OF_KX_WORKER_NODES.toInteger() )
} else {
totalLocalStorageRequired = ( number1GbVolumes + (number5GbVolumes * 5) + (number10GbVolumes * 10) + (number30GbVolumes * 30) + (number50GbVolumes * 50) ) * NUMBER_OF_KX_WORKER_NODES.toInteger()
}
int overallStorageRequired = totalLocalStorageRequired + NETWORK_STORAGE_OPTIONS.toInteger()

int overallStorageNeededPercentage = (overallStorageRequired / remainingDiskSpace) * 100
int overallRemainingPercentage = 100 - overallStorageNeededPercentage

int slaveTotalMemory = totalPhysicalMemorySize.toInteger()
int slaveFreeMemory = freePhysicalMemorySize.toInteger()

int usedMemory = slaveTotalMemory - slaveFreeMemory
int usedMemoryPercentage = ( usedMemory / slaveTotalMemory ) * 100
int freeMemoryPercentage = ( slaveFreeMemory / slaveTotalMemory ) * 100

int totalNeededMainNodeMemory = (KX_MAIN_ADMIN_MEMORY.toInteger()) * NUMBER_OF_KX_MAIN_NODES.toInteger()
int totalNeededMainNodeCpuCores = KX_MAIN_ADMIN_CPU_CORES.toInteger() * NUMBER_OF_KX_MAIN_NODES.toInteger()

int totalNeededWorkerNodeMemory = (KX_WORKER_NODES_MEMORY.toInteger()) * NUMBER_OF_KX_WORKER_NODES.toInteger()
int totalNeededWorkerNodeCpuCores = KX_WORKER_NODES_CPU_CORES.toInteger() * NUMBER_OF_KX_WORKER_NODES.toInteger()

int overallTotalNeededMemory = totalNeededMainNodeMemory + totalNeededWorkerNodeMemory
int overallTotalNeededCpuCores = totalNeededMainNodeCpuCores  + totalNeededWorkerNodeCpuCores

int overallUsedCpuCoresPercentage = (overallTotalNeededCpuCores / totalSystemCores.toInteger()) * 100
int overallUsedMemoryPercentage = (overallTotalNeededMemory / slaveTotalMemory) * 100

int overallRemainingCpuCoresPercentage = 100 - overallUsedCpuCoresPercentage
int overallRemainingMemoryPercentage = 100 - overallUsedMemoryPercentage

def normalPieColour="#9f4dd3"
def warningPieColour="#FF6200"
def alertPieColour="#f44336"

def cpuPieColor
def memoryPieColor
def diskPieColor

if ( overallUsedCpuCoresPercentage >= 90 && overallUsedCpuCoresPercentage < 100 ) {
cpuPieColor = warningPieColour
} else if ( overallUsedCpuCoresPercentage >= 100 ) {
cpuPieColor = alertPieColour
} else {
cpuPieColor = normalPieColour
}

if ( overallUsedMemoryPercentage >= 90 && overallUsedMemoryPercentage < 100 ) {
memoryPieColor = warningPieColour
} else if ( overallUsedMemoryPercentage >= 100 ) {
memoryPieColor = alertPieColour
} else {
memoryPieColor = normalPieColour
}

if ( overallStorageNeededPercentage >= 90 && overallStorageNeededPercentage < 100 ) {
diskPieColor = warningPieColour
} else if ( overallStorageNeededPercentage >= 100 ) {
diskPieColor = alertPieColour
} else {
diskPieColor = normalPieColour
}

return """
<body>
<div class="wrapper" style="width: 800px;">
    <div class="svg-item">

        <svg width="200px" height="200px" viewBox="0 0 40 40" class="donut">
            CPU
            <circle class="donut-hole" cx="20" cy="20" r="15.91549430918954" fill="#fff"></circle>
            <circle class="donut-ring" cx="20" cy="20" r="15.91549430918954" fill="transparent" stroke-width="3.5"></circle>
            <circle style="stroke: ${cpuPieColor};" class="donut-segment donut-segment-cpu" cx="20" cy="20" r="15.91549430918954" fill="transparent" stroke-width="3.5" stroke-dasharray="${overallUsedCpuCoresPercentage} ${overallRemainingCpuCoresPercentage}" stroke-dashoffset="25"></circle>
            <g class="donut-text donut-text-cpu">

                <text y="50%" transform="translate(0, 2)">
                    <tspan x="50%" text-anchor="middle" class="donut-percent" style="fill: ${cpuPieColor};">${overallUsedCpuCoresPercentage}%</tspan>
                </text>
                <text y="60%" transform="translate(0, 2)">
                    <tspan x="50%" text-anchor="middle" class="donut-data">${overallTotalNeededCpuCores} CPU Cores</tspan>
                </text>
            </g>
        </svg>
    </div>

    <div class="svg-item">
        <svg width="200px" height="200px" viewBox="0 0 40 40" class="donut">
            Memory
            <circle class="donut-hole" cx="20" cy="20" r="15.91549430918954" fill="#fff"></circle>
            <circle class="donut-ring" cx="20" cy="20" r="15.91549430918954" fill="transparent" stroke-width="3.5"></circle>
            <circle style="stroke: ${memoryPieColor};" class="donut-segment donut-segment-memory" cx="20" cy="20" r="15.91549430918954" fill="transparent" stroke-width="3.5" stroke-dasharray="${overallUsedMemoryPercentage} ${overallRemainingMemoryPercentage}" stroke-dashoffset="25"></circle>
            <g class="donut-text donut-text-memory">

                <text y="50%" transform="translate(0, 2)">
                    <tspan x="50%" text-anchor="middle" class="donut-percent" style="fill: ${memoryPieColor};">${overallUsedMemoryPercentage}%</tspan>
                </text>
                <text y="60%" transform="translate(0, 2)">
                    <tspan x="50%" text-anchor="middle" class="donut-data">${overallTotalNeededMemory/1024} GB Memory</tspan>
                </text>
            </g>++
        </svg>
    </div>

    <div class="svg-item">
        <svg width="200px" height="200px" viewBox="0 0 40 40" class="donut">
            Disk Space
            <circle class="donut-hole" cx="20" cy="20" r="15.91549430918954" fill="#fff"></circle>
            <circle class="donut-ring" cx="20" cy="20" r="15.91549430918954" fill="transparent" stroke-width="3.5"></circle>
            <circle style="stroke: ${diskPieColor};" class="donut-segment donut-segment-disk" cx="20" cy="20" r="15.91549430918954" fill="transparent" stroke-width="3.5" stroke-dasharray="${overallStorageNeededPercentage} ${overallRemainingPercentage}" stroke-dashoffset="25"></circle>
            <g class="donut-text donut-text-disk">

                <text y="50%" transform="translate(0, 2)">
                    <tspan x="50%" text-anchor="middle" class="donut-percent" style="fill: ${diskPieColor};">${overallStorageNeededPercentage}%</tspan>
                </text>
                <text y="60%" transform="translate(0, 2)">
                    <tspan x="50%" text-anchor="middle" class="donut-data">${overallStorageRequired} GB Disk Space</tspan>
                </text>
            </g>
        </svg>
    </div>
</div>
</body>

freePhysicalMemorySize: ${freePhysicalMemorySize}<br>
totalPhysicalMemorySize: ${totalPhysicalMemorySize}<br>
totalSystemCores: ${totalSystemCores}<br>
currentSystemDisk: ${currentSystemDisk}<br>
totalSystemDisk: ${totalSystemDisk}<br>
freeSystemDisk: ${freeSystemDisk}<br>
usableSystemDisk: ${usableSystemDisk}<br>

</html>
"""
