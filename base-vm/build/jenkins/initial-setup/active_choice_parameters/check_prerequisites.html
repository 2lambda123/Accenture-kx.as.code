import groovy.json.JsonSlurper

println("Entered check prerequisites - BEGINNING")

def githubVersionJson = new JsonSlurper().parse('https://raw.githubusercontent.com/patdel76/kx/main/versions.json'.toURL())
def githubKxVersion = githubVersionJson.kxascode
def githubKubeVersion = githubVersionJson.kubernetes

def localVersionFile = 'jenkins_shared_workspace/kx.as.code/versions.json'
def localVersionJson = new File(localVersionFile)
def parsedLocalVersionJson = new JsonSlurper().parse(localVersionJson)

def localKxVersion = parsedLocalVersionJson.kxascode
def localKubeVersion = parsedLocalVersionJson.kubernetes

println("Check prerequisites - Before OS check")

def OS = System.getProperty("os.name", "generic").toLowerCase(Locale.ENGLISH);
def virtualBoxPath
def vmWareWorkstationPath
def vmWareVagrantWorkstationPlugin = "vagrant-vmware-desktop"
def parallelsPath
def parallelsVagrantPlugin = "vagrant-parallels"

if ((OS.indexOf("mac") >= 0) || (OS.indexOf("darwin") >= 0)) {
    underlyingOS = "darwin"
    virtualBoxPath = "/Applications/VirtualBox.app/Contents/MacOS/VirtualBox"
    vmWareWorkstationPath = "/Applications/VMware Fusion.app/Contents/MacOS/VMware Fusion"
    parallelsPath = "/Applications/Parallels Desktop.app/Contents/MacOS/prl_client_app"
} else if (OS.indexOf("win") >= 0) {
    underlyingOS = "windows"
    virtualBoxPath = "C:/Program Files/Oracle/VirtualBox/VirtualBox.exe"
    vmWareWorkstationPath = "C:/Program Files (x86)/VMware/VMware Workstation/vmware.exe"
} else if (OS.indexOf("nux") >= 0) {
    underlyingOS = "linux"
    virtualBoxPath = "/usr/bin/VirtualBox"
    vmWareWorkstationPath = "/usr/bin/vmware"
} else {
    underlyingOS = "other"
}

println("Check prerequisites - After OS check")

def parallelsExecutableExists = ""
if ( underlyingOS == "darwin" ) {
    File parallelsExecutable = new File(parallelsPath)
    parallelsExecutableExists = parallelsExecutable.exists()
}

File vboxExecutable = new File(virtualBoxPath)
def vboxExecutableExists = vboxExecutable.exists()

File vmWareExecutable = new File(vmWareWorkstationPath)
def vmwareExecutableExists = vmWareExecutable.exists()

def vagrantPluginList = 'vagrant plugin list'.execute().text
vagrantPluginList = new String(vagrantPluginList).split( '\n' )
def vagrantPluginName
def vagrantPluginVersion
def vagrantVmwarePluginInstalled
def vagrantParallelsPluginInstalled
for (vagrantPlugin in vagrantPluginList) {
    vagrantPluginSplit = vagrantPlugin.split(" ")
    vagrantPluginName = vagrantPluginSplit[0]
    vagrantPluginVersion = vagrantPluginSplit[1]
    if ( vagrantPluginName == "vagrant-vmware-desktop" ) {
        vagrantVmwarePluginInstalled = true
    } else if ( vagrantPluginName == "parallels" ) {
        vagrantParallelsPluginInstalled = true
    }
}

def existingBoxes = 'vagrant box list'.execute().text
def boxes = new String(existingBoxes).split( '\n' )
println("existingBoxes" + existingBoxes)

println("[0]: " + boxes[0])
println("[1]: " + boxes[1])

def boxesList = []
def virtualBoxMainExists
def virtualBoxNodeExists
def vmWareMainExists
def vmWareNodeExists
def parallelsMainExists
def parallelsNodeExists

for (box in boxes) {
    boxItem = box.split(" ")
    boxName = boxItem[0].trim()
    boxProvider = boxItem[1].trim().replaceAll("[(),]","").replaceAll("_","-")
    boxVersion = boxItem[2].trim().replaceAll("[()]","")
    println(boxName + " " + boxProvider + " " + boxVersion)
    boxesList.add(boxName + " " + boxProvider + " " + boxVersion)
    if (boxName == "kx.as.code-main" && boxProvider == "virtualbox") {
        virtualBoxMainExists = "true"
    }
    if (boxName == "kx.as.code-node" && boxProvider == "virtualbox") {
        virtualBoxNodeExists = "true"
    }
    if (boxName == "kx.as.code-main" && boxProvider == "vmware-desktop") {
        vmWareMainExists = "true"
    }
    if (boxName == "kx.as.code-node" && boxProvider == "vmware-desktop") {
        vmWareNodeExists = "true"
    }
    if (boxName == "kx.as.code-main" && boxProvider == "parallels") {
        parallelsMainExists = "true"
    }
    if (boxName == "kx.as.code-node" && boxProvider == "parallels") {
        parallelsNodeExists = "true"
    }
}
println("All boxes: " + boxesList)
println("0: " + boxesList[0])
println("1: " + boxesList[1])

println("existingBoxes" + existingBoxes)

println("Check prerequisites - EOF")


return """
<head>
    <script>

        function getAvailableBoxes() {
            console.log("DEBUG: getAvailableBoxes()");
            let groovyUnformattedBoxesList = "${boxesList}".trim().slice(1,-1).split(',');
            console.log("Boxes List: " + groovyUnformattedBoxesList);
            console.log("Box 0: " + groovyUnformattedBoxesList[0]);
            console.log("Box 1: " + groovyUnformattedBoxesList[1]);
            let boxesList = [];
            for (const box of groovyUnformattedBoxesList){
                console.log("Split box list row: " + box);
                let [boxName, boxProvider, boxVersion] = box.trim().split(' ');
                console.log("Split row: " + boxName + "," + boxProvider + "," + boxVersion);
                boxesList.push({ "name": boxName, "provider": boxProvider, "version": boxVersion });
            }
            console.table(boxesList);
            let selectedProfile = document.getElementById("profiles").value
            // Get kx-main version
            try {
                console.log("Selected profile: " + selectedProfile);
                let boxKxMain = boxesList.find(boxKxMain => boxKxMain.provider === selectedProfile && boxKxMain.name === "kx.as.code-main");
                console.log("Found Main Boxes: " + boxKxMain);
                console.log("Box Main Name: " + boxKxMain.name);
                console.log("Box Main Provider: " + boxKxMain.provider);
                console.log("Box Main Version: " + boxKxMain.version);
                document.getElementById("kx-main-version").innerHTML = "v" + boxKxMain.version;
                document.getElementById("main-version-status-svg").src = "/userContent/icons/checkbox-marked-circle-outline.svg";
                document.getElementById("main-version-status-svg").className = "checklist-status-icon svg-bright-green";
            } catch(e){
                console.log("Lookup failed. Main Box does not exist")
                document.getElementById("kx-main-version").innerHTML = "<i>Not found</i>";
                document.getElementById("main-version-status-svg").src = "/userContent/icons/alert-outline.svg";
                document.getElementById("main-version-status-svg").className = "checklist-status-icon svg-orange-red";
            }

            // Get kx-node version
            try {
                console.log("Selected profile: " + selectedProfile);
                let boxKxNode = boxesList.find(boxKxNode => boxKxNode.provider === selectedProfile && boxKxNode.name === "kx.as.code-node");
                console.log("Found Node Boxes: " + boxKxNode);
                console.log("Box Node Name: " + boxKxNode.name);
                console.log("Box Node Provider: " + boxKxNode.provider);
                console.log("Box Node Version: " + boxKxNode.version);
                document.getElementById("kx-node-version").innerHTML = "v" + boxKxNode.version;
                document.getElementById("node-version-status-svg").src = "/userContent/icons/checkbox-marked-circle-outline.svg";
                document.getElementById("node-version-status-svg").className = "checklist-status-icon svg-bright-green";
            } catch(e){
                console.log("Lookup failed. Node Box does not exist")
                document.getElementById("kx-node-version").innerHTML = "<i>Not found</i>";
                document.getElementById("node-version-status-svg").src = "/userContent/icons/alert-outline.svg";
                document.getElementById("node-version-status-svg").className = "checklist-status-icon svg-orange-red";
            }
        }

        function compareVersions() {
            let githubKxVersion = "${githubKxVersion}";
            let githubKubeVersion = "${githubKubeVersion}";
            let localKxVersion = "${localKxVersion}";
            let localKubeVersion = "${localKubeVersion}";

            if (githubKxVersion !== localKxVersion) {
                console.log("KX Version mismatch. Your code is out of date");
                document.getElementById("version-check-message").innerHTML = "Your local checked out code (v" + localKxVersion + ") does not match the version on GitHub MAIN (v" + githubKxVersion + ")";
                document.getElementById("version-check-svg").src = "/userContent/icons/alert-outline.svg";
                document.getElementById("version-check-svg").className = "checklist-status-icon svg-orange-red";
            } else {
                console.log("KX Version is the same. Your code is up to date");
                document.getElementById("version-check-message").innerHTML = "The latest KX.AS.CODE source (v" + localKxVersion + ") is present on your machine";
                document.getElementById("version-check-svg").src = "/userContent/icons/checkbox-marked-circle-outline.svg";
                document.getElementById("version-check-svg").className = "checklist-status-icon svg-bright-green";
            }
        }

        function checkVagrantPreRequisites() {
            console.log("DEBUG: Inside checkVagrantPreRequisites");
            let selectedProfile = document.getElementById("profiles").value;
            let virtualizationExecutableExists = "";
            let vagrantPluginInstalled = "";

            if ( selectedProfile === "virtualbox" ) {
                virtualizationExecutableExists = "${vboxExecutableExists}";
                vagrantPluginInstalled = "true";
            } else if ( selectedProfile === "vmware-desktop" ) {
                virtualizationExecutableExists = "${vmwareExecutableExists}";
                vagrantPluginInstalled = "${vagrantVmwarePluginInstalled}";
            } else if ( selectedProfile === "parallels" ) {
                virtualizationExecutableExists = "${parallelsExecutableExists}";
                vagrantPluginInstalled = "${vagrantParallelsPluginInstalled}";
            }

            if ( virtualizationExecutableExists === "true" ) {
                document.getElementById("virtualization-svg").className = "checklist-status-icon svg-bright-green";
                document.getElementById("virtualization-svg").src = "/userContent/icons/checkbox-marked-circle-outline.svg";
                document.getElementById("virtualization-text").innerHTML = selectedProfile + " is installed";
            } else {
                document.getElementById("virtualization-svg").className = "checklist-status-icon svg-orange-red";
                document.getElementById("virtualization-svg").src = "/userContent/icons/alert-outline.svg";
                document.getElementById("virtualization-text").innerHTML = selectedProfile + " could not be found";
            }

            if ( vagrantPluginInstalled  === "true" ) {
                document.getElementById("vagrant-plugin-svg").className = "checklist-status-icon svg-bright-green";
                document.getElementById("vagrant-plugin-svg").src = "/userContent/icons/checkbox-marked-circle-outline.svg";
                document.getElementById("vagrant-plugin-text").innerHTML = "The required Vagrant plugin is installed";
            } else {
                document.getElementById("vagrant-plugin-svg").className = "checklist-status-icon svg-orange-red";
                document.getElementById("vagrant-plugin-svg").src = "/userContent/icons/alert-outline.svg";
                document.getElementById("vagrant-plugin-text").innerHTML = "The required Vagrant plugin could not be located";
            }
        }

        function updateProfileSelection() {
            let selectedProfile = document.getElementById("profiles").value
            // Set profile selection automatically if any of them meet all the pre-requisites
            let parallelsExecutableExists = "${parallelsExecutableExists}";
            let vboxExecutableExists = "${vboxExecutableExists}";
            let vmwareExecutableExists = "${vmwareExecutableExists}";
            let vboxVagrantPluginInstalled = "true";
            let vmwareVagrantPluginInstalled = "${vagrantVmwarePluginInstalled}";
            let parallelsPluginInstalled = "${vagrantParallelsPluginInstalled}";
            let virtualBoxMainExists = "${virtualBoxMainExists}";
            let virtualBoxNodeExists = "${virtualBoxNodeExists}";
            let vmWareMainExists = "${vmWareMainExists}";
            let vmWareNodeExists = "${vmWareNodeExists}";
            //let vmWareNodeExists = "";
            let parallelsMainExists = "${parallelsMainExists}";
            let parallelsNodeExists = "${parallelsNodeExists}";

            console.log("DEBUG: Selected profile: " + selectedProfile);

            let defaultProfile = "";
            let prerequisitesCheckResult = "";
            let selectedProfileCheckResult = "";

            if (sessionStorage.getItem('hasCodeRunBefore') === null) {
                if ( vboxExecutableExists === "true" && vboxVagrantPluginInstalled === "true" && virtualBoxMainExists === "true" && virtualBoxNodeExists === "true") {
                    console.log("DEBUG --> 1");
                    defaultProfile = "virtualbox";
                    if (selectedProfile === "virtualbox") { selectedProfileCheckResult = "full"; }
                    prerequisitesCheckResult = "full";
                } else if ( vmwareExecutableExists === "true" && vmwareVagrantPluginInstalled === "true" && vmWareMainExists === "true" && vmWareNodeExists === "true" ) {
                    console.log("DEBUG --> 2");
                    defaultProfile = "vmware-desktop";
                    prerequisitesCheckResult = "full";
                } else if ( parallelsExecutableExists === "true" && parallelsPluginInstalled === "true" && parallelsMainExists === "true" && parallelsNodeExists === "true" ) {
                    console.log("DEBUG --> 3");
                    defaultProfile = "parallels";
                    prerequisitesCheckResult = "full";
                } else if ( vboxExecutableExists === "true" && vboxVagrantPluginInstalled === "true" && virtualBoxMainExists === "true" ) {
                    console.log("DEBUG --> 4");
                    defaultProfile = "virtualbox";
                    prerequisitesCheckResult = "standalone";
                } else if ( vmwareExecutableExists === "true" && vmwareVagrantPluginInstalled === "true" && vmWareMainExists === "true" ) {
                    console.log("DEBUG --> 5");
                    defaultProfile = "vmware-desktop";
                    prerequisitesCheckResult = "standalone";
                } else if ( parallelsExecutableExists === "true" && parallelsPluginInstalled === "true" && parallelsMainExists === "true" ) {
                    console.log("DEBUG --> 6");
                    defaultProfile = "parallels";
                    prerequisitesCheckResult = "standalone";
                } else {
                    console.log("DEBUG: Inside else DEFAULT block");
                    prerequisitesCheckResult = "failed";
                }

                console.log("default profile will be set to " + defaultProfile);
                document.getElementById("profiles").value = defaultProfile;

                // Pre-requisite value must be either "full", "standalone" or "failed"
                document.getElementById("system-prerequisites-check").value = prerequisitesCheckResult;
                sessionStorage.hasCodeRunBefore = true;

                if ( prerequisitesCheckResult === "failed" ) {
                    hideParameterDivs();
                } else {
                    showParameterDivs();
                }

            }

            if (sessionStorage.getItem('hasCodeRunBefore') !== null) {
                if ( selectedProfile === "virtualbox" && vboxExecutableExists === "true" && vboxVagrantPluginInstalled === "true" && virtualBoxMainExists === "true" && virtualBoxNodeExists === "true") {
                    console.log("DEBUG --> 1");
                    selectedProfileCheckResult = "full";
                } else if ( selectedProfile === "vmware-desktop" && vmwareExecutableExists === "true" && vmwareVagrantPluginInstalled === "true" && vmWareMainExists === "true" && vmWareNodeExists === "true" ) {
                    console.log("DEBUG --> 2");
                    selectedProfileCheckResult = "full";
                } else if ( selectedProfile === "parallels" && parallelsExecutableExists === "true" && parallelsPluginInstalled === "true" && parallelsMainExists === "true" && parallelsNodeExists === "true" ) {
                    console.log("DEBUG --> 3");
                    selectedProfileCheckResult = "full";
                } else if ( selectedProfile === "virtualbox" && vboxExecutableExists === "true" && vboxVagrantPluginInstalled === "true" && virtualBoxMainExists === "true" ) {
                    console.log("DEBUG --> 4");
                    selectedProfileCheckResult = "standalone"
                } else if ( selectedProfile === "vmware-desktop" && vmwareExecutableExists === "true" && vmwareVagrantPluginInstalled === "true" && vmWareMainExists === "true" ) {
                    console.log("DEBUG --> 5");
                    selectedProfileCheckResult = "standalone";
                } else if ( selectedProfile === "parallels" && parallelsExecutableExists === "true" && parallelsPluginInstalled === "true" && parallelsMainExists === "true" ) {
                    console.log("DEBUG --> 6");
                    selectedProfileCheckResult = "standalone";
                } else {
                    console.log("DEBUG: Inside else SELECTED block");
                    selectedProfileCheckResult = "failed";
                }

                // Pre-requisite value must be either "full", "standalone" or "failed"
                document.getElementById("system-prerequisites-check").value = selectedProfileCheckResult;
                console.log("selected profile prerequisite check result: " + selectedProfileCheckResult);

                if ( selectedProfileCheckResult === "failed" ) {
                    hideParameterDivs();
                } else {
                    showParameterDivs();
                }

            }

        }

    </script>

    <style>

        .checklist-status-icon {
            width: 25px;
            height: 25px;
        }

    </style>
</head>
<body>
<div class="divider-parameter-span"></div>
<h2>Pre-requisite Checks</h2>
<h4>Virtualization Pre-Requisites</h4>
<div><span class="checklist-span"><img src='' id='virtualization-svg' class='' alt='virtualization-svg' /></span><span id="virtualization-text" class="checklist-span" style="width: 300px;display:inline-block;"></span><span class="checklist-span"><img src='' id='main-version-status-svg' class='' alt='main-version-status-svg' /></span><span class="checklist-span">KX-Main Box Version: </span><span id="kx-main-version" class="checklist-span"></span></div>
<div><span class="checklist-span"><img src='' id='vagrant-plugin-svg' class='' alt='vagrant-plugin-svg' /></span><span id="vagrant-plugin-text" class="checklist-span" style="width: 300px;display:inline-block;"></span><span class="checklist-span"><img src='' id='node-version-status-svg' class='' alt='node-version-status-svg' /></span><span class="checklist-span">KX-Node Box Version: </span><span id="kx-node-version" class="checklist-span"></span></div>
<br>
<h4>KX.AS.CODE Source</h4>
<div><span class="checklist-span"><img src='' id='version-check-svg' class='' alt='version-check-svg' /></span><span class="checklist-span" id="version-check-message"></span></div>
<br>
<style scoped="scoped" onload="getAvailableBoxes(); compareVersions(); checkVagrantPreRequisites(); updateProfileSelection();">   </style>
<input type="hidden" id="system-prerequisites-check" name="value" value="">
</body>

"""
