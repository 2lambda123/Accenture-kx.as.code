import groovy.json.JsonSlurper
import groovy.json.JsonBuilder
import java.nio.file.*

template_paths=[]
new File('jenkins_shared_workspace/kx.as.code/templates/').eachFileMatch( ~/^aq.*.json$/ ) {template_paths<< it.path }

template_paths_csv = template_paths.join(",")
template_paths_csv = template_paths_csv.replaceAll("\\\\", "/")
println(template_paths_csv)

def componentDirectory
def metadataInputFilePath
def category
def component
def metadataInputFile
def metadataJson
def shortcutIcon
def shortcutText
def description
def jsonFilePath
def inputFile
def parsedJson
def template_items = []
def templateComponentsArray = []
def templateDefinitionsArray = []
def template_id
def template_name
def template_description
def template_path

for (int i = 0; i < template_paths.size(); i++) {

    jsonFilePath = template_paths[i]
    inputFile = new File(jsonFilePath)
    parsedJson = new JsonSlurper().parse(inputFile)

    template_id = i
    template_items = parsedJson.action_queues.install
    template_name = parsedJson.title
    template_description = parsedJson.description
    template_path = jsonFilePath.replaceAll("\\\\", "/")

    templateDefinitionsArray.add( '[ "template_id":' + template_id + ',' + '"template_name":' + '"' + template_name + '",' + '"template_description":' + '"' + template_description + '",' + '"template_path":' + '"' + template_path + '"]')

    for(int j = 0; j < template_items.size(); j++) {
        category=parsedJson.action_queues.install[j].install_folder
        component=parsedJson.action_queues.install[j].name
        componentDirectory="jenkins_shared_workspace/kx.as.code/auto-setup/${category}/${component}"
        metadataInputFilePath="${componentDirectory}/metadata.json"
        println(metadataInputFilePath)
        metadataInputFile = new File(metadataInputFilePath)
        metadataJson = new JsonSlurper().parse(metadataInputFile)
        description = metadataJson.Description
        shortcutText = metadataJson.shortcut_text
        shortcutIcon = metadataJson.shortcut_icon
        println("/userContent/icons/${shortcutIcon}")
        try {
            //Files.copy(jenkins_shared_workspace/kx.as.code/auto-setup/${category}/${component}/${shortcutIcon}, jenkins_home/userContent/icons/${shortcutIcon})
            def fileEx = new File("jenkins_shared_workspace/kx.as.code/auto-setup/${category}/${component}/${shortcutIcon}")
            def fileDest = new File("jenkins_home/userContent/icons/${shortcutIcon}")
            def fileExPath = fileEx.toPath()
            def fileDestPath = fileDest.toPath()
            Files.copy(fileExPath, fileDestPath, StandardCopyOption.COPY_ATTRIBUTES)
        } catch(e) {
            println e
        }
        templateComponentsArray.add( '[' + '"template_id":' + template_id + ',' + '"shortcutText":' + '"' + shortcutText + '",' + '"shortcutIcon":' + '"' + "${shortcutIcon}" + '",' + '"description":' + '"' + description + '",' + '"category":' + '"' + category + '",' + '"component":' + '"' + component + '"]' )
    }
}

println(templateComponentsArray)

return """
<head>
    <script>
        function getTemplates() {
            console.log("Inside getTemplates()");
            let templateDefinitionsArray='${templateDefinitionsArray}'.replaceAll('[', '{').replaceAll(']', '}').replaceAll('{{', '[{').replaceAll('}}', '}]');
            console.table(templateDefinitionsArray);
            let definitionsArray = JSON.parse(templateDefinitionsArray);
            console.table(definitionsArray);

            try {
                let selectedTemplate = "CICD Group 1";
                let definitionArray = definitionsArray.find(template => template.template_name === selectedTemplate);
                console.log("Found template definition id: " + definitionArray.template_id);
                getTemplateComponents(definitionArray.template_id)
            } catch(e){
                console.log("Lookup failed")
            }

        }

        function getTemplateComponents(templateId) {
            console.log("Inside getTemplateComponents(" + templateId + ")");
            let templateComponentsArray='${templateComponentsArray}'.replaceAll('[', '{').replaceAll(']', '}').replaceAll('{{', '[{').replaceAll('}}', '}]');
            console.table(templateComponentsArray);
            let componentsArray = JSON.parse(templateComponentsArray);
            console.table(componentsArray);
            let shortcutIcon
            try {
                let componentArray = componentsArray.findAll(templateComponent => templateComponent.template_id === templateId);
                console.log("returned array size: " + componentArray.size());
                for ( let i = 0; i < componentArray.size(); i++ ) {
                    console.log("Found template components - shortcutText[" + i + "]: " + componentArray[i].shortcutText);
                    console.log("Found template components - category [" + i + "]: " + componentArray[i].category);
                    console.log("Found template components - description [" + i + "]: " + componentArray[i].description);
                    console.log("Found template components - shortcutIcon [" + i + "]: " + componentArray[i].shortcutIcon);
                    console.log("Found template components - component [" + i + "]: " + componentArray[i].component);

                    if ( componentArray[i].shortcutText !== "null" && componentArray[i].shortcutIcon !== "null" ) {
                        let iDiv = document.createElement('div');
                        iDiv.id = componentArray[i].component;
                        iDiv.className = 'component-item';

                        if (componentArray[i].shortcutIcon === "null") {
                            shortcutIcon = 'application-cog-outline.svg';
                        } else {
                            shortcutIcon = componentArray[i].shortcutIcon;
                        }

                        let componentItemInnerHTML = '<div class="component-outer-div">' +
                                '<div class="component-image-div">' +
                                    '<img src="/userContent/icons/' + shortcutIcon + '" width="60">' +
                                '</div>' +
                                '<div class="component-outer-text-div">' +
                                    '<div class="component-category-div">' + componentArray[i].category + '</div>' +
                                    '<div class="component-title-div">' + componentArray[i].shortcutText + '</div>' +
                                '</div>' +
                            '</div>' +
                            '<div>' +
                            '   <span class="component-description-span">' + componentArray[i].description +'</span>' +
                            '</div>';
                        console.log(componentItemInnerHTML);
                        iDiv.innerHTML = componentItemInnerHTML;
                        document.getElementById('components-list').appendChild(iDiv);
                    }
                }
            } catch(e){
                console.log("Lookup failed" + e)
            }

        }

        function populate_template_option_list() {
            let templates = "${template_paths_csv}".split(',');
            console.log("templates.length: " + templates.length);
            for ( let i = 0; i < templates.length; i++ ) {
                let templateName = templates[i].split("/").pop();
                templateName = templateName.replace("aq-", "").replace(".json", "");
                console.log("Adding template to options: " + templateName + i);
                document.getElementById("templates").options[i] = new Option(templateName, templateName);
                update_template_selected_value();
            }
        }

        function update_template_selected_value() {
            let selectedOptionNumber = document.getElementById("templates").selectedIndex;
            let template_paths = "${template_paths}".split(',');
            let templatePath = "aq-" + template_paths[selectedOptionNumber] + ".json"
            console.log("templateName: " + templatePath)
            document.getElementById("selected-template").value = templatePath;
            document.getElementById("selected-template").setAttribute("selected-template", templatePath);
            let parentId = document.getElementById("selected-template").parentNode.id;
            console.log(parentId);
            jQuery('#' + parentId).trigger('change');
        }

    </script>
    <style>

        .component-container {
            display: flex;
            padding: 10px;
            align-items: stretch;
            justify-content : flex-start;
            flex-wrap: wrap;
            flex-direction: row;
            max-width: 850px;
            gap: 10px 10px;
            row-gap: 10px;
            column-gap: 10px;
            background: rgba(117,0,192,0.05);
            display: -webkit-box;
            display: -moz-box;
            display: -ms-flexbox;
            display: -webkit-flex;
        }

        .component-item {
            display: block;
            padding: 20px;
            align-items: center;
            background: #FFFFFF;
            width: 200px;
            height: 200px;
        }

        .component-outer-div {
            display:inline-block;
        }

        .component-image-div {
            padding: 5px;
            padding-top: 10px;
            width: 40%;
            float: left;
        }

        .component-outer-text-div {
            padding: 5px;
            text-transform: capitalize;
            width:60%;
            height: 100px;
            float: right;
        }

        .component-category-div {
            padding-left: 15px;
            padding-top: 10px;
            color: #7500c0;
        }

        .component-title-div {
            padding-left: 15px;
        }

        .component-description-span {
            padding-left: 5px;
            width:100%;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

    </style>
</head>
<body>
TESTING 1 2 3 TEMPLATES<br>
templateComponentsArray: ${templateComponentsArray}<br>
<label for="templates" class="input-box-label">Profiles</label><select id="templates" class="profiles-select capitalize" onchange="update_template_selected_value();"></select></label>
<input type="hidden" id="selected-template" name="value" value="">
<style scoped="scoped" onload="getTemplates(); populate_template_option_list();">   </style>
<br>templateDefinitionsArray: ${templateDefinitionsArray}<br>
<div class="component-container" id="components-list">
</div>
</body>
"""
